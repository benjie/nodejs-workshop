<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">

    <title>Node.js tutorial by @Benjie</title>

    <meta name="description" content="An introduction to Node.js for programmers">
    <meta name="author" content="Benjie Gillam">

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="css/reveal.min.css">
    <link rel="stylesheet" href="css/theme/default.css" id="theme">

    <!-- For syntax highlighting -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <!-- If the query includes 'print-pdf', use the PDF print sheet -->
    <script>
      document.write( '<link rel="stylesheet" href="css/print/' + ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">' );
    </script>

    <style>
      .reveal pre code {
        max-height: 600px;
      }
    </style>

    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
  </head>

  <body>

    <div class="reveal">

      <!-- Any section element inside of this container is displayed as a slide -->
      <div class="slides">

        <section>
          <h1>Node.js workshop</h1>
          <p>
            <small>By <a href="http://twitter.com/Benjie" target="assistant">@Benjie</a></small>
          </p>
        </section>

        <section>
          <h1>Introduction</h1>
        </section>

        <section>
          <h2>Installing Node.js</h2>
          <p>
            Get the latest stable version of Node from <a href="http://nodejs.org/download/" target="assistant">nodejs.org/download</a> and install it.
          </p>
          <p>Mac: <code>brew install node</code></p>
          <p>Linux: <code>[sudo] tar zxf node-*.tar.gz --strip-components=1 -C /usr/local</code></p>
          <pre><code>$ uname -a # Linux .... i686 &lt; 32bit or something64 &lt; 64bit</code></pre>
          <p><br /></p>
          <p>Once installed, run <code>node</code> in the command line:</p>
          <pre><code>$ node
&gt; 1+2
3
&gt; ^D</code></pre>
          <p><em>You may need to update your <code>$PATH</code> so it can find node</em></p>

          <aside class='notes'>
            What is node?
            <ul>
              <li>Not a networked web browser - No DOM*! </li>
              <li>Single threaded</li>
              <li>Good at I/O bound</li>
              <li>Not good at computation heavy (at least not in a server setting</li>
            </ul>
          </aside>
        </section>

        <section>
          <h2>Hello World!</h2>
          <p>Add the following to <code>hello-world.js</code></p>
          <p><pre><code>console.log("Hello world!");</code></pre></p>
          <p>And then run it:</p>
          <p><pre><code>$ node hello-world.js
Hello world!
$ </code></pre></p>
        </section>

        <section>
          <h2>Hello REPL!</h2>
          <h3>Read-Eval-Print-Loop</h3>
          <p><pre><code>$ node
&gt; console.log("Hello world!");
Hello world!
undefined
&gt; 1+2
3
&gt; {}+{}
'[object Object][object Object]'
&gt; </code></pre></p>
        </section>

        <section>
          <h1>JavaScript Basics</h1>
        </section>

        <section>
          <h3>Super Quick Summary</h3>
          <pre class='fragment'><code>/* Variables  */ var one = 1;</code></pre>
          <pre class='fragment'><code>/* Objects    */ var obj = {}; obj.property = one;</code></pre>
          <pre class='fragment'><code>/* Arrays     */ var arr = [one, obj];</code></pre>
          <pre class='fragment'><code>/* Primatives */ var prims = [-1.3, "Str", true, null, undefined]; </code></pre>
          <pre class='fragment'><code>/* Buffers    */ var b = new Buffer("Hello world!");
                 b.toString('base64'); /* or hex or utf8 or ... */</code></pre>
          <pre class='fragment'><code>/* Undefined  */ var v; if (v === undefined) { console.log("Careful"); } </code></pre>
          <pre class='fragment'><code>/* typeof     */ if (typeof v === 'undefined') { console.log("Good"); } </code></pre>
          <pre class='fragment'><code>/* Accessing  */ console.log(arr[1]['property']);</code></pre>
          <pre class='fragment'><code>/* Concat     */ console.log("Join " + val + " and " + 3.03);                    // Fix code colouring </code></pre>
          <pre class='fragment'><code>/* Functions  */ function myFunc(param) { console.log("Got: "+param); }</code></pre>
          <pre class='fragment'><code>/* 1st class  */ function seven(fn) { fn(7); }; seven(myFunc);</code></pre>
          <pre class='fragment'><code>/* Anonymous  */ seven(function(nr) { console.log(nr * nr); }); </code></pre>
        </section>

        <section>
          <h3>Classes</h3>
          <pre><code>function Animal() {}</code></pre>
          <pre class='fragment'><code>Animal.prototype.getType = function() {
  return 'an animal';
}</code></pre>
          <pre class='fragment'><code>Animal.prototype.announceSelf = function() {
  console.log("I am "+this.getType());
}</code></pre>
          <pre class='fragment'><code>var a = new Animal();
a.announceSelf();</code></pre>
          <pre class='fragment'><code>function Cat() {}</code></pre>
          <pre class='fragment'><code>Cat.prototype = new Animal();</code></pre>
          <pre class='fragment'><code>Cat.prototype.getType = function() {
  return 'a cat';
}</code></pre>
          <pre class='fragment'><code>var c = new Cat();
c.announceSelf();</code></pre>
        </section>

        <section>
          <h3>Scope and closures</h3>
          <pre><code>var a = 1;
function logA() {
  console.log("a = "+a);
  var b = a;
}
logA(); // a = 1</code></pre>
          <pre class='fragment'><code>function logB() {
  console.log("typeof b = "+(typeof b));
  a = 3;
}
logB(); // typeof b = undefined
logA(); // a = 3</code></pre>
          <pre class='fragment'><code>(function() {
  var c = 5;
  function logC() {
    console.log("c = "+c);
  }
  logC(); // c = 5
  this.exportedLogC = logC;
})();</code></pre>
          <pre class='fragment'><code>exportedLogC(); // c = 5
console.log(typeof c); // undefined</code></pre>
        </section>

        <section>
          <h2>Hello Internet!</h2>
          <p>Enter the following into <code>server.js</code></p>
          <p><pre><code>var http = require('http');

function listener(request, response) {
  response.end("Hello world!");
}

var server = http.createServer(listener);
server.listen(1337);</code></pre></p>
          <p>Then run it:</p>
          <p><pre><code>$ node server.js</code></pre></p>
          <p>Open <a href="http://localhost:1337" target="assistant">http://localhost:1337</a></p>
        </section>

        <section>
          <h2>Exhibitionist</h2>
          <p>Let's share our own source code with the world:</p>
          <p><pre><code>var http = require('http');
var fs = require('fs');

function listener(request, response) {
  function send(err, contents) {
    if (err) {
      console.error(err); // DON'T DO THIS IN PRODUCTION
      response.writeHead(500);
      response.end("ERROR");
    } else {
      response.end(contents);
    }
  }
  fs.readFile(require.main.filename, send);
}

var server = http.createServer(listener);
server.listen(1337);</code></pre></p>
          <p class='fragment'>But this means if we have a traffic surge we'll get <code>EMFILE</code> - too many files open.</p>
        </section>

        <section>
          <h2><span style='color:green'>Graceful</span> Exhibitionist</h2>
          <p>Let's <span style='color:green'>gracefully</span> share our own source code with the world:</p>
          <p><pre><code>var http = require('http');
//var fs = require('fs');
var fs = require('graceful-fs'); // npm install graceful-fs

function listener(request, response) {
  function send(err, contents) {
    if (err) {
      console.error(err); // DON'T DO THIS IN PRODUCTION
      response.writeHead(500);
      response.end("ERROR");
    } else {
      response.end(contents);
    }
  }
  fs.readFile(require.main.filename, send);
}

var server = http.createServer(listener);
server.listen(1337);</code></pre></p>
          <p class='fragment'>But this means we have to open the file over and over again, despite it's relatively small size</p>
        </section>

        <section>
          <h2>Preloading</h2>
<p><pre><code>var http = require('http');
var fs = require('graceful-fs');
var fileContents;

function listener(request, response) {
  response.end(fileContents);
}

var server = http.createServer(listener);

function read(err, contents) {
  if (err) {
    console.error(err);
    process.exit(1);
  } else {
    fileContents = contents;
    server.listen(1337);
  }
}

fs.readFile(require.main.filename, read);</code></pre></p>
        </section>

        <section>
          <h2>Benchmark (snipped)</h2>
          <p><pre><code>$ ab -n 10000 -c 100  http://127.0.0.1:1337/
Document Length:        388 bytes
Time taken for tests:   1.395 seconds
Failed requests:        0
Write errors:           0
Requests per second:    7166.71 [#/sec] (mean)
Time per request:       13.953 [ms] (mean)
Time per request:       0.140 [ms] (mean, across all concurrent requests)

Connection Times (ms)
              min  mean[+/-sd] median   max
Connect:        0    0   4.1      0     234
Processing:     1   14  26.1     10     246
Waiting:        1   14  26.1     10     246
Total:          4   14  26.4     10     247

Percentage of the requests served within a certain time (ms)
  50%     10
  66%     10
  75%     10
  80%     11
  90%     13
  95%     14
  98%     20
  99%    148
 100%    247 (longest request)</code></pre></p>
        </section>

        <section>
          <h1>The Runloop</h1>
        </section>

        <section>
          <h2>The Runloop</h2>
          <p>Largest waste of time in code is waiting on IO. Here are the options we have for dealing with this:</p>
          <ul>
            <li class='fragment'>Synchronous (procedural)</li>
            <li class='fragment'>Fork</li>
            <li class='fragment'>Threads</li>
            <li class='fragment'>Events (callbacks)</li>
          </ul>
          <aside class='notes'>
            Synchronous: easy; slow, queues<br />
            Fork: easy; doesn't scale.<br />
            Threads: easy, nicer than fork; complicated access to shared resources.<br />
          </aside>
        </section>

        <section>
          <h2>Threads vs events</h2>
          <p class='fragment'><img src="img/nginx-apache-memory.png" /></p>
          <p class='fragment'>Source: <a href="http://blog.webfaction.com/2008/12/a-little-holiday-present-10000-reqssec-with-nginx-2/" target="assistant">http://blog.webfaction.com/2008/12/a-little-holiday-present-10000-reqssec-with-nginx-2/</a></p>
        </section>

        <section>
          <h2>Single thread for JavaScript</h2>
          <p class='fragment'>Your code should request work, optional callback.</p>
          <pre class='fragment'><code>var http = require('http');
function listener(request, response) {/* ... */}
var server = http.createServer(listener /* <- callback */);
server.listen(1337); /* <- request work */</code></pre>
          <p class='fragment'>Background thread pool handles work.</p>
          <pre class='fragment'><code>GET / HTTP/1.0</code></pre>
          <p class='fragment'>Node triggers callback when IO occurs/completes.</p>
          <pre class='fragment'><code>var request = new http.IncomingMessage(/* ... */);
var response = new http.ServerResponse(/* ... */);
listener(request, response);</code></pre>
          <p class='fragment'>Repeat</p>
          <pre class='fragment'><code>function listener(request, response) {
  response.end("Hello world!"); /* <- request work */
} </code></pre>
        </section>

        <section>
          <h1>Modules</h1>
        </section>

        <section>
          <h2>Module basics</h2>
          <aside class='notes'>
            <p>Own closure</p>
            <p>exports</p>
            <p>module.exports</p>
          </aside>
          <div class='fragment'>
            <pre style='width:48%; float: left;'><code>/* server.js */
var http = require('http');
var myModule = require('./my-module');

var server = http.createServer(
  myModule.serveSource
);
server.listen(1337);</code></pre>
            <pre style='width:48%; float: right;'><code>/* my-module.js */
var fs = require('graceful-fs');

function listener(request, response) {
  function send(err, contents) {
    if (err) {
      console.error(err);
      response.writeHead(500);
      response.end("ERROR");
    } else {
      response.end(contents);
    }
  }
  fs.readFile(
    require.main.filename,
    send
  );
}

exports.serveSource = listener;</code></pre>
          </div>
        </section>

        <section>
          <h2>npm - node packaged modules</h2>
          <p>Comes with Node.js nowadays</p>
          <p>Search: <code>npm search graceful-fs</code></p>
          <p class='fragment'>Install: <code>npm install grafeful-fs coffee-script</code></p>
          <p class='fragment'>Install globally: <code>[sudo] npm install -g nodemon</code></p>
          <p class='fragment'>Installs to <code>node_modules</code></p>
          <p class='fragment'>Include: <code>var fs = require('graceful-fs');</code></p>
          <p class='fragment'>Uninstall: <code>npm uninstall grafeful-fs</code></p>
        </section>

        <section>
          <h2>npm tips</h2>
          <p>Create a package.json interactively: <code>npm init</code></p>
          <p class='fragment'>Prevent accidental publishing to npm: <code>"private":true</code></p>
          <p class='fragment'>Install and save dependency: <code>npm install --save express</code></p>
          <p class='fragment'>Save by default: <code>npm config set save true</code></p>
          <p class='fragment'>Jump to documentation for a module: <code>npm docs coffee-script</code></p>
        </section>

        <section>
          <h2>more npm tips</h2>
          <p>Define scripts:</p>
          <pre><code>"scripts": {
  "truth": "echo Node.js rocks",
  "test": "echo All tests pass",
  "start": "node index.js"
}</code></pre>
          <p>Run tests: <code>npm test</code></p>
          <p>Run other scripts: <code>npm run truth</code></p>
          <p>Start the main app: <code>npm start</code></p>
        </section>

        <section>
          <h1>Debugging</h1>
        </section>

        <section>
          <h2>node-inspector</h2>
          <pre><code>npm install -g node-inspector</code></pre>
          <pre><code>node --debug server.js</code></pre>
          <pre><code>node-inspector &</code></pre>
          <p><a href="http://127.0.0.1:8080/debug?port=5858" target="assistant">http://127.0.0.1:8080/debug?port=5858</a> in Chrome</p>
          <p class='fragment'>Select <code>my-module.js</code> on the left</p>
          <p class='fragment'>Add a breakpoint to <code>response.send(contents);</code></p>
          <p class='fragment'>Load your server (http://localhost:1337/)</p>
          <p class='fragment'>Now edit the code!</p>
        </section>

        <section>
          <h2>Express</h2>
        </section>

        <section>
          <h2>CoffeeScript</h2>
        </section>

        <section>
          <h1>Callback hell</h1>
          <h3><a href="http://callbackhell.com/" target="assistant">callbackhell.com</a></h3>
        </section>


        <section>
          <h2>Nodecopter modules</h2>
        </section>

      </div>

    </div>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.min.js"></script>

    <script>

      // Full list of configuration options available here:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: true,

        theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
        transition: Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/zoom/linear/fade/none

        // Optional libraries used to extend on reveal.js
        dependencies: [
          { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
          { src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
          { src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
          // { src: 'plugin/search/search.js', async: true, condition: function() { return !!document.body.classList; } }
          // { src: 'plugin/remotes/remotes.js', async: true, condition: function() { return !!document.body.classList; } }
        ]
      });

    </script>

  </body>
</html>
